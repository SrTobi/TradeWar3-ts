name: Deploy to Hetzner VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: hetzner
    permissions: {}

    steps:
      - name: Deploy to Hetzner VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: ${{ secrets.HETZNER_SSH_PORT }}
          script: |
            set -e

            REPO_URL="https://github.com/${{ github.repository }}.git"
            REPO_DIR=~/tradewar-server
            DOMAIN="${{ secrets.DOMAIN }}"

            # Clone or pull the repository
            if [ -d "$REPO_DIR/.git" ]; then
              echo "Updating existing repository..."
              cd "$REPO_DIR"
              git fetch origin
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              rm -rf "$REPO_DIR"
              git clone "$REPO_URL" "$REPO_DIR"
              cd "$REPO_DIR"
            fi

            # Install pnpm if not available
            if ! command -v pnpm &> /dev/null; then
              echo "Installing pnpm..."
              npm install -g pnpm
            fi

            # Install dependencies and bundle server
            echo "Installing dependencies..."
            pnpm install

            echo "Bundling server..."
            pnpm run bundle:server

            # Stop existing server if running
            if [ -f server.pid ]; then
              OLD_PID=$(cat server.pid)
              if kill -0 $OLD_PID 2>/dev/null; then
                echo "Stopping existing server (PID: $OLD_PID)..."
                kill $OLD_PID || true
                sleep 2
              fi
              rm -f server.pid
            fi

            # Start game server with nohup
            echo "Starting game server..."
            nohup node server-bundle/server.js > server.log 2>&1 &
            echo $! > server.pid

            # Wait and verify server started
            sleep 3
            if kill -0 $(cat server.pid) 2>/dev/null; then
              echo "Game server started successfully (PID: $(cat server.pid))"
              tail -5 server.log
            else
              echo "Game server failed to start. Logs:"
              cat server.log
              exit 1
            fi

            # Install and configure Caddy for HTTPS if domain is set
            if [ -n "$DOMAIN" ]; then
              echo "Setting up Caddy for HTTPS..."
              
              # Install Caddy if not present
              if ! command -v caddy &> /dev/null; then
                echo "Installing Caddy..."
                apt-get update
                apt-get install -y debian-keyring debian-archive-keyring apt-transport-https curl
                curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
                curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
                apt-get update
                apt-get install -y caddy
              fi

              # Create Caddyfile
              echo "Configuring Caddy for domain: $DOMAIN"
              cat > /etc/caddy/Caddyfile << EOF
            $DOMAIN {
                # Serve static files (if built frontend exists)
                root * $REPO_DIR/dist
                file_server

                # WebSocket proxy for the game server
                handle /ws {
                    reverse_proxy localhost:12346
                }

                # Fallback to index.html for SPA routing
                try_files {path} /index.html
            }
            EOF

              # Reload Caddy
              systemctl reload caddy || systemctl start caddy
              echo "Caddy configured and running for $DOMAIN"
            else
              echo "No DOMAIN secret set - skipping Caddy setup"
              echo "Game server running on port 12346 (WebSocket only)"
            fi
