name: Deploy to Hetzner VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: hetzner
    permissions: {}

    steps:
      - name: Deploy to Hetzner VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: ${{ secrets.HETZNER_SSH_PORT }}
          script: |
            set -e

            REPO_URL="https://github.com/${{ github.repository }}.git"
            REPO_DIR=~/tradewar-server
            DOMAIN="${{ secrets.DOMAIN }}"

            # Clone or pull the repository
            if [ -d "$REPO_DIR/.git" ]; then
              echo "Updating existing repository..."
              cd "$REPO_DIR"
              git fetch origin
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              rm -rf "$REPO_DIR"
              git clone "$REPO_URL" "$REPO_DIR"
              cd "$REPO_DIR"
            fi

            # Stop existing container if running
            echo "Stopping existing container..."
            docker stop tradewar-galaxy 2>/dev/null || true
            docker rm tradewar-galaxy 2>/dev/null || true

            # Build Docker image
            echo "Building Docker image..."
            docker build -t tradewar-galaxy .

            # Run container with Caddy for HTTPS
            echo "Starting container with HTTPS support..."
            if [ -n "$DOMAIN" ]; then
              # Production: Use domain for automatic HTTPS certificates
              docker run -d \
                --name tradewar-galaxy \
                --restart unless-stopped \
                -p 80:80 \
                -p 443:443 \
                -e DOMAIN="$DOMAIN" \
                -v caddy_data:/data \
                -v caddy_config:/config \
                tradewar-galaxy
              echo "Server started with HTTPS on domain: $DOMAIN"
            else
              # Development: Use localhost without HTTPS
              docker run -d \
                --name tradewar-galaxy \
                --restart unless-stopped \
                -p 80:80 \
                tradewar-galaxy
              echo "Server started on port 80 (no HTTPS - set DOMAIN secret for production)"
            fi

            # Wait and verify container started
            sleep 5
            if docker ps | grep -q tradewar-galaxy; then
              echo "Container started successfully"
              docker logs tradewar-galaxy --tail 10
            else
              echo "Container failed to start. Logs:"
              docker logs tradewar-galaxy
              exit 1
            fi

