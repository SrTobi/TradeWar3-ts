name: Deploy to Hetzner VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Bundle server
        run: pnpm run bundle:server

      - name: Upload server bundle
        uses: actions/upload-artifact@v4
        with:
          name: server-bundle
          path: server-bundle/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: hetzner
    permissions: {}

    steps:
      - name: Download server bundle
        uses: actions/download-artifact@v4
        with:
          name: server-bundle
          path: server-bundle/

      - name: Copy server bundle to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: ${{ secrets.HETZNER_SSH_PORT }}
          source: "server-bundle/server.js"
          target: "~/tradewar-server"
          strip_components: 1

      - name: Deploy and run server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: ${{ secrets.HETZNER_SSH_PORT }}
          script: |
            set -e

            cd ~/tradewar-server

            # Install ws dependency if needed
            if [ ! -d "node_modules/ws" ]; then
              npm init -y 2>/dev/null || true
              npm install ws
            fi

            # Stop existing server if running
            if [ -f server.pid ]; then
              OLD_PID=$(cat server.pid)
              if kill -0 $OLD_PID 2>/dev/null; then
                echo "Stopping existing server (PID: $OLD_PID)..."
                kill $OLD_PID || true
                sleep 2
              fi
              rm -f server.pid
            fi

            # Start server with nohup
            echo "Starting server..."
            nohup node server.js > server.log 2>&1 &
            echo $! > server.pid

            # Wait and verify server started
            sleep 3
            if kill -0 $(cat server.pid) 2>/dev/null; then
              echo "Server started successfully (PID: $(cat server.pid))"
              tail -5 server.log
            else
              echo "Server failed to start. Logs:"
              cat server.log
              exit 1
            fi
