name: Deploy to Hetzner VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: hetzner
    permissions: {}

    steps:
      - name: Deploy to Hetzner VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USERNAME }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: ${{ secrets.HETZNER_SSH_PORT }}
          script: |
            set -e

            REPO_URL="https://github.com/${{ github.repository }}.git"
            REPO_DIR=~/tradewar-server

            # Clone or pull the repository
            if [ -d "$REPO_DIR/.git" ]; then
              echo "Updating existing repository..."
              cd "$REPO_DIR"
              git fetch origin
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              rm -rf "$REPO_DIR"
              git clone "$REPO_URL" "$REPO_DIR"
              cd "$REPO_DIR"
            fi

            # Install pnpm if not available
            if ! command -v pnpm &> /dev/null; then
              echo "Installing pnpm..."
              npm install -g pnpm
            fi

            # Install dependencies and bundle server
            echo "Installing dependencies..."
            pnpm install

            echo "Bundling server..."
            pnpm run bundle:server

            # Stop existing server if running
            if [ -f server.pid ]; then
              OLD_PID=$(cat server.pid)
              if kill -0 $OLD_PID 2>/dev/null; then
                echo "Stopping existing server (PID: $OLD_PID)..."
                kill $OLD_PID || true
                sleep 2
              fi
              rm -f server.pid
            fi

            # Start server with nohup
            echo "Starting server..."
            nohup node server-bundle/server.js > server.log 2>&1 &
            echo $! > server.pid

            # Wait and verify server started
            sleep 3
            if kill -0 $(cat server.pid) 2>/dev/null; then
              echo "Server started successfully (PID: $(cat server.pid))"
              tail -5 server.log
            else
              echo "Server failed to start. Logs:"
              cat server.log
              exit 1
            fi
